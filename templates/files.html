<!-- templates/files.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>File Vault</title>
  <style>
    body { padding:20px; }
    nav { margin-bottom:20px; }
    nav a { margin: 0 10px; font-weight:bold; text-decoration:none; }
    #toast { position:fixed; top:20px; right:20px;
      background:#333; color:#fff; padding:10px; border-radius:4px;
      opacity:0; transition:opacity .5s; }
    #toast.show { opacity:1; }
    .btn { margin:5px; }
    .delete-btn, .rename-btn { margin-left:8px; cursor:pointer; }
    .rename-btn { color:orange; }
    #drop-area { border:2px dashed #666; padding:20px;
      text-align:center; margin-bottom:10px; cursor:pointer; }
    #drop-area.highlight { background:#f0f0f0; }
  </style>
</head>
<body>
  <nav>
    <a href="https://realmsg-nczs7egjq56agdygntzkr6.streamlit.app/" target="_blank">Real time messages</a> |
    <a href="https://chatgpt.com" target="_blank">OPENAI</a> |
    <a href="https://copilot.microsoft.com/chats/wMXwk4qrrPCAaR4s86tsn" target="_blank">Copilot</a> |
    <a href="https://chat.deepseek.com/" target="_blank">Deepseek</a> |
    <a href="https://www.google.com/" target="_blank">Google</a> |
    <a href="https://drive.google.com/drive/home" target="_blank">Google Drive</a>
  </nav>

  <div id="toast"></div>
  <button id="refreshBtn" class="btn">Refresh</button>

  {% if role in ['admin','owner'] %}
  <h2>Upload / Save URL</h2>

  <div id="drop-area">Drag &amp; drop file here or click to browse</div>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.py,.ipynb" style="display:none;">
    <input type="text" name="custom_name" placeholder="Custom filename.ext">
    <button type="submit" class="btn">Upload</button>
  </form>

  <form id="urlForm">
    <input type="url" name="url" placeholder="https://example.com">
    <button type="submit" class="btn">Save URL</button>
  </form>

  <div class="token-section">
    <h2>Dropbox Token</h2>
    <a href="https://www.dropbox.com/developers/apps/info/kw1ztfsray6hj0l" target="_blank">
      <button class="btn">Get Token</button>
    </a>
    <form id="tokenForm">
      <input type="text" name="token" placeholder="Paste new access token" style="width:300px;">
      <button type="submit" class="btn">Set Token</button>
    </form>


        <button id="showTokenBtn">Show Token</button>
    <h3 id="token" style="display: none;">sl.u.AFoR3VQP7u0n4z7SpP0W777vNBmyokyGagwLVmKbk2BwOvQIDEnr3ndIYFesUBfiC-K4kyAS7aBQ2IxrQvUOSL_E1qrC3bGJUFt6J61FpTiv-z6oKQUm_W71mCFn2nazLzB5RY7IJv1C05xlNEvOFJiIEq0Eu62HGi80mVn4NlyeCQLiof8UO1X_JKbgMbnNLx9obPAkKj__Xf3c-e59UXjuPoBwXXNXV-8IC_EgjDbyDfc1-cgZCwunW7xGbKR5LoZBCGy4pXa1RExvCnvMHOHP3AXMON51o9o7ES8VNgjAFxTewbZOLQsC7wczrv1HTjy508VnY12G3eDrXzyTQZ-HBCqgJQkl6GOeJkPtxqfo7FlI4491k1ou_Vfv13EBnU56YpgcT1FIKl_cThyH5JpnJwPEDZfc-f5ZOtfSbNKwocFL6GUUqO2K1NKnIhVVWaTrTGxiw2k195WJAw03PeTH17Btxznh_HKxld4T10t79vzHUavc-nFJ9NI6fL1WpOJ2YC19V-Pojw_PH0qsxJYNEL9j5hjynhjYL02VQbx96I7NSG8h8UhTKvKX_tOM1sz4kxeigPbDpY-l-RNqjpRvYjGQWBaUgFTqkCOARSl9SiZIgE0QRrquixvbP9XCa4cYeEt3CZcyZ4pYwlVsmU2LkkYZGjja34J4pWEOtWqJjfNp9abDYICEcmyifETLH6rNuhFEdbEJ5So-1bxKJHxfgsNN4wVEGG7uYhRXYcuywAYocgU0N6FqtAfbqbz-8tEwvUfaPA0iajYQUgL-TRgl8lYWNQAhv9NdbQlIoMlRcQ2s0l0MR4LMTTbOj9kz0V0y_k85YZDDknKE8DO-0mDLd1I7r0xjaPqsTRZueHgkpwDgyrwVR5LZAw8a_qOud1uyLZBq84O6OjP63LmVaK8PGsEZ_S7sszBckUzD1wUmUyu8S8YgJeJy_u9G8ytse1ZNjJW_GXx7FwDLdvaGVV7jIuRI-FT2AUFv6BhkdgCYY157gKYaD5DyMOVEPkyoePYgB2sYWvWfhoIo8cZyJNxpVwvcoP2hO7alZJP3BCXLQsVsUw339YP6lW5zY9ZDTkxuUDdcx-EpwZx5pB7hSlJrMw9MqlD1HAQAIAIpI9ddQIJgZOx-8ZQyrsdoPKvYcH4gvbONa9S67e1xYgyVBiCBu9cX2QEv3FPDk9KwyZqrNaIq1t-p6W8nkGRuBgcnkkI0ELYDe6l4zNQ8Ori27vQdMm4XHa7yFFG-EE01Bc9yRitlP9K8DskQXlG_5mHQM4RFbE0gENBIaRuyTOjWKmALKYxlkuYDcG0FwMHMbz0uww</h3>
    <script>
      document.getElementById('showTokenBtn').addEventListener('click', function() {
        const tokenElement = document.getElementById('token');
        tokenElement.style.display = tokenElement.style.display === 'none' ? 'block' : 'none';
      });
    </script>
  </div>
  {% endif %}

  <h2>Available Files</h2>
  <ul id="fileList"></ul>

  <script>
    const role = "{{ role }}", toast = document.getElementById('toast');
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),3000);
    }

    // Drag & Drop boilerplate
    const dropArea = document.getElementById('drop-area'),
          fileInput = document.getElementById('fileInput');
    ;['dragenter','dragover'].forEach(e=>dropArea.addEventListener(e,ev=>{ev.preventDefault();dropArea.classList.add('highlight');}));
    ;['dragleave','drop'].forEach(e=>dropArea.addEventListener(e,ev=>{ev.preventDefault();dropArea.classList.remove('highlight');}));
    dropArea.addEventListener('drop', ev=>{ if(ev.dataTransfer.files.length) fileInput.files = ev.dataTransfer.files; });
    dropArea.addEventListener('click', ()=>fileInput.click());

    // Fetch & render
    async function fetchFiles() {
      const list = await fetch('/files').then(r=>r.json());
      const ul = document.getElementById('fileList');
      ul.innerHTML = '';
      list.forEach(f=>{
        let li = document.createElement('li'),
            html = `<a href="${f.link}" download="${f.name}">${f.name}</a>`;
        if(['admin','owner'].includes(role)) html += `<span class="rename-btn" data-name="${f.name}">[rename]</span>`;
        if(role==='owner') html += `<span class="delete-btn" data-name="${f.name}">[del]</span>`;
        li.innerHTML = html; ul.appendChild(li);
      });
    }

    document.getElementById('refreshBtn').onclick = fetchFiles;

    // Delegated actions
    document.body.addEventListener('click', async ev=>{
      if(ev.target.matches('.delete-btn')){
        const name=ev.target.dataset.name;
        const res=await fetch('/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}).then(r=>r.json());
        showToast(res.status==='deleted'?'Deleted':'Error'); fetchFiles();
      }
      if(ev.target.matches('.rename-btn')){
        const old=ev.target.dataset.name, neu=prompt('New filename',old);
        if(neu&&neu!==old){
          const res=await fetch('/rename',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old,new:neu})}).then(r=>r.json());
          showToast(res.status==='renamed'?'Renamed':'Error'); fetchFiles();
        }
      }
    });

    // Upload/URL/Token
    if(['admin','owner'].includes(role)){
      uploadForm.onsubmit = async e=>{
        e.preventDefault();
        const msg=await fetch('/upload',{method:'POST',body:new FormData(uploadForm)}).then(r=>r.text());
        showToast(msg); fetchFiles();
      };
      urlForm.onsubmit = async e=>{
        e.preventDefault();
        const msg=await fetch('/upload',{method:'POST',body:new URLSearchParams(new FormData(urlForm))}).then(r=>r.text());
        showToast(msg); fetchFiles();
      };
      tokenForm.onsubmit = async e=>{
        e.preventDefault();
        const token=tokenForm.token.value.trim();
        const res=await fetch('/set_token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token})}).then(r=>r.json());
        showToast(res.status==='token updated'?'Token updated ðŸ”‘':'Error');
      };
    }

    // hide UI until logs fire off
    fetchFiles();
  </script>
</body>
</html>
